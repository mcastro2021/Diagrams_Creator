<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Diagrams - Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .diagram { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { margin: 5px; padding: 10px 15px; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 Test de Diagramas - Debug</h1>
    
    <div>
        <button onclick="loadDiagrams()">📊 Cargar Lista de Diagramas</button>
        <button onclick="testDiagramAccess()">🧪 Probar Acceso</button>
        <button onclick="console.clear()">🧹 Limpiar Console</button>
    </div>
    
    <div id="status"></div>
    <div id="diagrams-list"></div>
    
    <script>
        const BASE_URL = 'http://localhost:5000';
        
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="${type}">${message}</div>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        async function loadDiagrams() {
            try {
                showStatus('🔄 Cargando diagramas...', 'info');
                
                const response = await fetch(`${BASE_URL}/api/diagrams-debug`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 Diagrams data:', data);
                
                if (data.success) {
                    displayDiagrams(data.diagrams);
                    showStatus(`✅ ${data.count} diagramas encontrados`, 'success');
                } else {
                    showStatus(`❌ Error: ${data.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error loading diagrams:', error);
                showStatus(`❌ Error: ${error.message}`, 'error');
            }
        }
        
        function displayDiagrams(diagrams) {
            const container = document.getElementById('diagrams-list');
            
            if (!diagrams || diagrams.length === 0) {
                container.innerHTML = '<p>No hay diagramas disponibles</p>';
                return;
            }
            
            let html = '<h2>📋 Diagramas Disponibles:</h2>';
            
            diagrams.forEach((diagram, index) => {
                html += `
                    <div class="diagram">
                        <h3>📊 Diagrama ${index + 1}</h3>
                        <p><strong>ID:</strong> <code>${diagram.id}</code></p>
                        <p><strong>Archivo:</strong> ${diagram.filename}</p>
                        <p><strong>Tamaño:</strong> ${diagram.size} bytes</p>
                        <p><strong>Creado:</strong> ${diagram.created}</p>
                        <p><strong>URL:</strong> <code>${diagram.direct_url}</code></p>
                        <div>
                            <button onclick="testDiagramUrl('${diagram.id}', '${diagram.direct_url}')">
                                🧪 Probar URL
                            </button>
                            <button onclick="openInDrawio('${diagram.id}')">
                                🌐 Abrir en Draw.io
                            </button>
                            <button onclick="downloadDiagram('${diagram.id}')">
                                💾 Descargar
                            </button>
                        </div>
                        <pre>${diagram.content_preview}</pre>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function testDiagramUrl(id, url) {
            try {
                showStatus(`🧪 Probando acceso a diagrama ${id}...`, 'info');
                console.log(`Testing URL: ${url}`);
                
                const response = await fetch(url);
                console.log(`Response status: ${response.status} ${response.statusText}`);
                console.log(`Response headers:`, response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const content = await response.text();
                console.log(`Content preview (first 200 chars):`, content.substring(0, 200));
                
                showStatus(`✅ Diagrama ${id} accesible. Tamaño: ${content.length} caracteres`, 'success');
                
            } catch (error) {
                console.error(`Error testing diagram ${id}:`, error);
                showStatus(`❌ Error probando ${id}: ${error.message}`, 'error');
            }
        }
        
        function openInDrawio(id) {
            const diagramUrl = `${BASE_URL}/api/diagram/${id}`;
            const drawioUrl = `https://app.diagrams.net/?url=${encodeURIComponent(diagramUrl)}`;
            
            console.log(`Opening in Draw.io:`, drawioUrl);
            showStatus(`🌐 Abriendo diagrama ${id} en Draw.io...`, 'info');
            
            window.open(drawioUrl, '_blank');
        }
        
        function downloadDiagram(id) {
            const url = `${BASE_URL}/api/diagram/${id}`;
            
            console.log(`Downloading from:`, url);
            showStatus(`💾 Descargando diagrama ${id}...`, 'info');
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagram_${id}.xml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        async function testDiagramAccess() {
            showStatus('🧪 Probando acceso a todos los diagramas...', 'info');
            await loadDiagrams();
        }
        
        // Auto-cargar al iniciar
        window.addEventListener('load', () => {
            showStatus('🚀 Página cargada. Haz clic en "Cargar Lista de Diagramas"', 'info');
        });
    </script>
</body>
</html>
